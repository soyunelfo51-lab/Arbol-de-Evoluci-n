<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nox | Protocolo Zero</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="glitch-overlay">
        <img id="glitch-img" src="https://fortnite-api.com/images/cosmetics/br/lsid_375_guavaevent_9gxe3/background.png" alt="ERROR SISTEMA"> 
        <h1 class="glitch-text-overlay">ERROR DEL SISTEMA</h1>
    </div>

    <div class="space-bg">
        <div class="stars-layer"></div>
        <div class="stars-layer" style="animation-duration: 150s; opacity: 0.5;"></div>
    </div>

    <div id="intro-wrapper">
        <section id="welcome-screen">
            <div class="zero-point-orb"></div>
            <h1 class="welcome-title">NOX PROTOCOL</h1>
            <div class="welcome-subtitle">SISTEMA DE EVOLUCIÓN HABILITADO</div>
            <button class="scroll-down-btn" onclick="scrollToLogin()">Iniciar Sistema</button>
            <div class="scroll-arrow">▼</div>
        </section>

        <div id="login-screen">
            <img src="https://media1.tenor.com/m/HON-W7311M4AAAAd/fortnite-point-zero.gif" alt="Punto Cero" class="author-avatar-login">
            <div class="login-box">
                <h1>ACCESO AGENTE</h1>
                <input type="text" id="username" placeholder="NOMBRE CLAVE">
                <input type="password" id="password" placeholder="CONTRASEÑA">
                <button onclick="handleLogin()">CONECTAR AL BUCLE</button>
            </div>
        </div>
    </div>

    <!-- BOTONES DE CONTROL FIJOS -->
    <button id="config-btn" onclick="toggleConfigMenu()">☰</button>
    <button id="logout-btn" onclick="logoutSystem()" style="display: none;">CERRAR SESIÓN</button>
    <div id="config-menu" class="config-menu">
        <div class="config-item">
            <label>Modo Tema:</label>
            <select id="theme-select" onchange="changeTheme(this.value)">
                <option value="dark">Oscuro</option>
                <option value="light">Claro</option>
                <option value="auto">Auto</option>
            </select>
        </div>
        <div class="config-item">
            <label>// ACCESO CLASIFICADO //</label>
            <input type="password" id="config-staff-code" placeholder="CÓDIGO DE MANDO" onkeydown="checkStaffCodeFromConfig(event)">
        </div>
        <button onclick="closeConfigMenu()" class="config-close">Cerrar</button>
    </div>

    <div id="main-interface">
        <button id="admin-back-btn" onclick="exitViewMode()">CERRAR VISTA REMOTA</button>

        <div class="resources-hud">
            <div class="resource-circle res-blue"><span class="res-label">Pts Evo</span><span class="res-val" id="hud-blue">0</span></div>
            <div class="resource-circle res-yellow"><span class="res-label">Evolución</span><span class="res-val" id="hud-yellow">0</span></div>
            <div class="resource-circle res-purple"><span class="res-label">Misterio</span><span class="res-val" id="hud-purple">0</span></div>
        </div>

        <div id="username-display">Agente: Nox</div>

        <div class="tree-container">
            <div class="tree">
                <ul>
                    <li>
                        <div class="node unlocked" id="root-node">
                            <img src="https://cdn-icons-png.flaticon.com/512/1177/1177568.png" class="node-icon" alt="User">
                            <div><span id="tree-username">Usuario</span></div>
                        </div>
                        <ul>
                            <li>
                                <div class="node" onclick="unlockNode(this, 'stats_base')" id="stats_base">
                                    <img src="https://cdn-icons-png.flaticon.com/512/2503/2503493.png" class="node-icon" alt="Stats">
                                    <div>Stats<span class="desc"></span></div>
                                </div>
                                <ul>
                                    <li><div class="node" onclick="tryUnlockMutual(this, 's_fuerza', ['s_resis'])" id="s_fuerza">Fuerza</div>
                                        <ul><li><div class="node" onclick="unlockNode(this, 'f_200')" id="f_200">+200</div>
                                            <ul><li><div class="node" onclick="unlockNode(this, 'f_500')" id="f_500">+500</div>
                                                <ul><li><div class="node" onclick="unlockNode(this, 'f_1200')" id="f_1200">+1300</div></li></ul>
                                            </li></ul>
                                        </li></ul>
                                    </li>
                                    <li><div class="node" onclick="tryUnlockMutual(this, 's_resis', ['s_fuerza'])" id="s_resis">Resis.</div>
                                        <ul><li><div class="node" onclick="unlockNode(this, 'r_200')" id="r_200">+200</div>
                                            <ul><li><div class="node" onclick="unlockNode(this, 'r_500')" id="r_500">+500</div>
                                                <ul><li><div class="node" onclick="unlockNode(this, 'r_1200')" id="r_1200">+1300</div></li></ul>
                                            </li></ul>
                                        </li></ul>
                                    </li>
                                </ul>
                            </li>

                            <li>
                                <div class="node" onclick="unlockNode(this, 'dones_base')" id="dones_base">
                                    <img src="https://cdn-icons-png.flaticon.com/512/5727/5727965.png" class="node-icon" alt="Dones">
                                    <div>Mejorar Dones<span class="desc">Ver a Nox</span></div>
                                </div>
                                <ul>
                                    <li><div class="node" onclick="unlockNode(this, 'cat_atk')" id="cat_atk">
                                        <img src="https://cdn-icons-png.flaticon.com/512/9458/9458472.png" class="node-icon" alt="Atk">
                                        <div>Ataque</div></div>
                                        <ul><li><div class="node" onclick="unlockNode(this, 'atk_h1')" id="atk_h1">H1</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'atk_h1_dmg', ['atk_h1_sz'])" id="atk_h1_dmg">Daño</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'atk_h1_sz', ['atk_h1_dmg'])" id="atk_h1_sz">Tamaño</div></li></ul></li>
                                            <li><div class="node" onclick="unlockNode(this, 'atk_h2')" id="atk_h2">H2</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'atk_h2_dmg', ['atk_h2_sz'])" id="atk_h2_dmg">Daño</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'atk_h2_sz', ['atk_h2_dmg'])" id="atk_h2_sz">Tamaño</div></li></ul></li>
                                            <li><div class="node" onclick="unlockNode(this, 'atk_h3')" id="atk_h3">H3</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'atk_h3_dmg', ['atk_h3_sz'])" id="atk_h3_dmg">Daño</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'atk_h3_sz', ['atk_h3_dmg'])" id="atk_h3_sz">Tamaño</div></li></ul></li>
                                        </ul>
                                    </li>
                                    <li><div class="node" onclick="unlockNode(this, 'cat_def')" id="cat_def">
                                        <img src="https://cdn-icons-png.flaticon.com/512/13665/13665746.png" class="node-icon" alt="Def">
                                        <div>Defensa</div></div>
                                        <ul><li><div class="node" onclick="unlockNode(this, 'def_h1')" id="def_h1">H1</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'def_h1_res', ['def_h1_dur'])" id="def_h1_res">Resis.</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'def_h1_dur', ['def_h1_res'])" id="def_h1_dur">Duración</div></li></ul></li>
                                            <li><div class="node" onclick="unlockNode(this, 'def_h2')" id="def_h2">H2</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'def_h2_res', ['def_h2_dur'])" id="def_h2_res">Resis.</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'def_h2_dur', ['def_h2_res'])" id="def_h2_dur">Duración</div></li></ul></li>
                                            <li><div class="node" onclick="unlockNode(this, 'def_h3')" id="def_h3">H3</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'def_h3_res', ['def_h3_dur'])" id="def_h3_res">Resis.</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'def_h3_dur', ['def_h3_res'])" id="def_h3_dur">Duración</div></li></ul></li>
                                        </ul>
                                    </li>
                                    <li><div class="node" onclick="unlockNode(this, 'cat_inv')" id="cat_inv">
                                        <img src="https://cdn-icons-png.flaticon.com/512/2182/2182893.png" class="node-icon" alt="Inv">
                                        <div>Invocación</div></div>
                                        <ul><li><div class="node" onclick="unlockNode(this, 'inv_h1')" id="inv_h1">H1</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'inv_h1_tm', ['inv_h1_pw', 'inv_h1_st'])" id="inv_h1_tm">Tiempo</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'inv_h1_pw', ['inv_h1_tm', 'inv_h1_st'])" id="inv_h1_pw">Poder</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'inv_h1_st', ['inv_h1_tm', 'inv_h1_pw'])" id="inv_h1_st">Stats</div></li></ul></li>
                                            <li><div class="node" onclick="unlockNode(this, 'inv_h2')" id="inv_h2">H2</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'inv_h2_tm', ['inv_h2_pw', 'inv_h2_st'])" id="inv_h2_tm">Tiempo</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'inv_h2_pw', ['inv_h2_tm', 'inv_h2_st'])" id="inv_h2_pw">Poder</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'inv_h2_st', ['inv_h2_tm', 'inv_h2_pw'])" id="inv_h2_st">Stats</div></li></ul></li>
                                            <li><div class="node" onclick="unlockNode(this, 'inv_h3')" id="inv_h3">H3</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'inv_h3_tm', ['inv_h3_pw', 'inv_h3_st'])" id="inv_h3_tm">Tiempo</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'inv_h3_pw', ['inv_h3_tm', 'inv_h3_st'])" id="inv_h3_pw">Poder</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'inv_h3_st', ['inv_h3_tm', 'inv_h3_pw'])" id="inv_h3_st">Stats</div></li></ul></li>
                                        </ul>
                                    </li>
                                    <li><div class="node" onclick="unlockNode(this, 'cat_pas')" id="cat_pas">
                                        <img src="https://cdn-icons-png.flaticon.com/512/32/32341.png" class="node-icon" alt="Pas">
                                        <div>Pasivo</div></div>
                                        <ul><li><div class="node" onclick="unlockNode(this, 'pas_h1')" id="pas_h1">H1<span class="desc">Mejora</span></div></li>
                                            <li><div class="node" onclick="unlockNode(this, 'pas_h2')" id="pas_h2">H2<span class="desc">Mejora</span></div></li>
                                            <li><div class="node" onclick="unlockNode(this, 'pas_h3')" id="pas_h3">H3<span class="desc">Mejora</span></div></li>
                                        </ul>
                                    </li>
                                    <li><div class="node" onclick="unlockNode(this, 'cat_arm')" id="cat_arm">
                                        <img src="https://cdn-icons-png.flaticon.com/512/870/870191.png" class="node-icon" alt="Arm">
                                        <div>Armamento</div></div>
                                        <ul><li><div class="node" onclick="unlockNode(this, 'arm_1')" id="arm_1">Armamento 1</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'arm_1_w', ['arm_1_a'])" id="arm_1_w">Arma</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'arm_1_a', ['arm_1_w'])" id="arm_1_a">Armadura</div></li></ul></li>
                                            <li><div class="node" onclick="unlockNode(this, 'arm_2')" id="arm_2">Armamento 2</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'arm_2_w', ['arm_2_a'])" id="arm_2_w">Arma</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'arm_2_a', ['arm_2_w'])" id="arm_2_a">Armadura</div></li></ul></li>
                                            <li><div class="node" onclick="unlockNode(this, 'arm_3')" id="arm_3">Armamento 3</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'arm_3_w', ['arm_3_a'])" id="arm_3_w">Arma</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'arm_3_a', ['arm_3_w'])" id="arm_3_a">Armadura</div></li></ul></li>
                                        </ul>
                                    </li>
                                    <li><div class="node" onclick="unlockNode(this, 'cat_trans')" id="cat_trans">
                                        <img src="https://cdn-icons-png.flaticon.com/512/6081/6081180.png" class="node-icon" alt="Trans">
                                        <div>Transf.</div></div>
                                        <ul><li><div class="node" onclick="unlockNode(this, 'tr_h1')" id="tr_h1">H1</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'tr_h1_t', ['tr_h1_g'])" id="tr_h1_t">Tiempo</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'tr_h1_g', ['tr_h1_t'])" id="tr_h1_g">Global</div></li></ul></li>
                                            <li><div class="node" onclick="unlockNode(this, 'tr_h2')" id="tr_h2">H2</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'tr_h2_t', ['tr_h2_g'])" id="tr_h2_t">Tiempo</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'tr_h2_g', ['tr_h2_t'])" id="tr_h2_g">Global</div></li></ul></li>
                                            <li><div class="node" onclick="unlockNode(this, 'tr_h3')" id="tr_h3">H3</div>
                                                <ul><li><div class="node" onclick="tryUnlockMutual(this, 'tr_h3_t', ['tr_h3_g'])" id="tr_h3_t">Tiempo</div></li>
                                                    <li><div class="node" onclick="tryUnlockMutual(this, 'tr_h3_g', ['tr_h3_t'])" id="tr_h3_g">Global</div></li></ul></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            
                            <li><div class="node" onclick="unlockNode(this, 'new_base')" id="new_base">
                                <img src="https://cdn-icons-png.flaticon.com/512/1828/1828884.png" class="node-icon" alt="New">
                                <div>Nuevos Dones<span class="desc">Habla con Nox</span></div>
                                </div>
                                <ul>
                                    <li><div class="node" onclick="unlockNode(this, 'new_1')" id="new_1">Reliquia Antiguo</div></li>
                                    <li><div class="node" onclick="unlockNode(this, 'new_2')" id="new_2">Sangre Dragón</div></li>
                                    <li><div class="node" onclick="unlockNode(this, 'new_3')" id="new_3">Alas Astrales</div></li>
                                    <li><div class="node" onclick="unlockNode(this, 'new_4')" id="new_4">Corazón Titán</div></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

    </div>

    <div id="admin-panel">
        <h1 class="admin-header">PANEL DE CONTROL DE MANDO (ADMIN)</h1>
        <button onclick="location.reload()" style="background: var(--danger-red); width: auto; display:inline-block;">Cerrar Sesión</button>
        <table>
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Azul (Evo)</th>
                    <th>Amarillo (Evo)</th>
                    <th>Morado (???)</th>
                    <th>Árbol</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="admin-user-list"></tbody>
        </table>
    </div>

    <footer>
        <div class="footer-content">
            <img src="https://www.aguait.cat/wp-content/uploads/2017/10/Clark-Reading-the-Daily-Planet-.jpg" alt="Nox" class="footer-img">
            <div>
                <h3 style="margin:0; color: var(--neon-blue); font-size: 14px; letter-spacing: 2px;">CREADO POR NOX / DRYON</h3>
                <small style="color: #aaa; font-size: 10px;">Powered by The Zero Point</small>
            </div>
        </div>
    </footer>

    <script>
        // --- 1. PEGA AQUÍ TU CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCdQ3Cao35AeXLFsEZYqW2yWB6nd9fJon8",
            authDomain: "arbol-240f2.firebaseapp.com",
            databaseURL: "https://arbol-240f2-default-rtdb.firebaseio.com",
            projectId: "arbol-240f2",
            storageBucket: "arbol-240f2.firebasestorage.app",
            messagingSenderId: "891396023772",
            appId: "1:891396023772:web:12bee4e18fde7d3eeb1b19",
            measurementId: "G-1X3E2P6PTS"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let currentUserData = null;
        let isAdminViewing = false; 

        // MANEJO DE HISTORIAL (FLECHAS ATRAS/ADELANTE)
        window.addEventListener('load', () => {
            // Estado inicial al cargar
            history.replaceState({page: 'login'}, "Login", "");
        });

        window.onpopstate = (event) => {
            if(event.state) {
                if(event.state.page === 'login') showLogin(false);
                else if (event.state.page === 'tree') loadInterface(false); // false = no empujar otro estado
                else if (event.state.page === 'admin') loadAdminPanel(false);
            } else {
                showLogin(false);
            }
        };

        function scrollToLogin() {
            document.getElementById('login-screen').scrollIntoView({ behavior: 'smooth' });
        }

        function showLogin(push = true) {
            document.getElementById('intro-wrapper').style.display = 'block';
            document.getElementById('main-interface').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('admin-back-btn').style.display = 'none';
            document.getElementById('config-btn').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'none';
            if(push) history.pushState({page: 'login'}, "Login", "#login");
            window.scrollTo(0,0);
        }

        // --- LOGIN ---
        function handleLogin() {
            const user = document.getElementById('username').value.trim().toLowerCase();
            const pass = document.getElementById('password').value;

            if (!user || !pass) return alert("Rellena datos");

            // Buscar usuario en la Nube
            db.ref('users/' + user).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.password === pass) {
                        enterSystem(data);
                    } else {
                        triggerGlitchError();
                    }
                } else {
                    if(confirm("Usuario no existe. ¿Crear agente " + user + "?")) {
                        const newUser = {
                            username: user,
                            password: pass,
                            points: { blue:0, yellow:0, purple:0 },
                            unlocked: ['root-node'],
                            locked: []
                        };
                        db.ref('users/' + user).set(newUser);
                        enterSystem(newUser);
                    }
                }
            });
        }

        function enterSystem(data) {
            currentUser = data.username;
            currentUserData = data;
            history.pushState({page: 'tree'}, "Árbol de Habilidades", "#tree");
            loadInterface(false);

            // ESCUCHAR CAMBIOS EN TIEMPO REAL
            db.ref('users/' + currentUser).on('value', (snap) => {
                if(snap.exists()){
                    currentUserData = snap.val();
                    updateHUD();
                    renderTreeState();
                }
            });
        }

        // --- FUNCIÓN DE GLITCH ---
        function triggerGlitchError() {
            const overlay = document.getElementById('glitch-overlay');
            const body = document.body;
            overlay.style.display = 'flex';
            body.classList.add('shake-screen');

            // 5 SEGUNDOS
            setTimeout(() => {
                overlay.style.display = 'none';
                body.classList.remove('shake-screen');
            }, 5000);
        }

        function loadInterface(push = true) {
            if(push) history.pushState({page: 'tree'}, "Árbol", "#tree");
            
            document.getElementById('intro-wrapper').style.display = 'none';
            document.getElementById('main-interface').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('config-btn').style.display = 'block';
            
            // Si entramos desde historial y no tenemos user cargado
            if(!currentUser && !isAdminViewing) {
                showLogin(false);
                return;
            }

            document.getElementById('tree-username').innerText = currentUser;
            document.getElementById('username-display').innerText = isAdminViewing ? "VISTA REMOTA: " + currentUser : "Agente: " + currentUser;
            
            // El logout-btn solo en árbol normal del usuario, no en vista remota
            if(!isAdminViewing) {
                document.getElementById('logout-btn').style.display = 'block';
            } else {
                document.getElementById('logout-btn').style.display = 'none';
            }

            updateHUD();
            renderTreeState();
        }

        function updateHUD() {
            if(!currentUserData) return;
            document.getElementById('hud-blue').innerText = currentUserData.points.blue;
            document.getElementById('hud-yellow').innerText = currentUserData.points.yellow;
            document.getElementById('hud-purple').innerText = currentUserData.points.purple;
        }

        function renderTreeState() {
            if(!currentUserData) return;
            document.querySelectorAll('.node').forEach(el => el.classList.remove('unlocked', 'locked-forever'));
            if(currentUserData.unlocked) {
                currentUserData.unlocked.forEach(id => {
                    let el = document.getElementById(id);
                    if(el) el.classList.add('unlocked');
                });
            }
            if(currentUserData.locked) {
                currentUserData.locked.forEach(id => {
                    let el = document.getElementById(id);
                    if(el) el.classList.add('locked-forever');
                });
            }
        }

        // --- ACCIONES DEL ÁRBOL (Guardan en la Nube) ---
function unlockNode(el, id) {
    // HE ELIMINADO LA LÍNEA QUE BLOQUEABA AL ADMIN (isAdminViewing)
    
    if(!currentUserData) return;

    // Verificaciones normales
    if(currentUserData.unlocked && currentUserData.unlocked.includes(id)) return;
    if(currentUserData.locked && currentUserData.locked.includes(id)) return alert("Bloqueado");

    // Lógica de compra
    if(currentUserData.points.yellow > 0) {
        // Mensaje diferente si eres admin para que sepas que estás editando a otro
        let msg = isAdminViewing ? 
                  "ADMIN: ¿Gastar 1 punto de " + currentUser + "?" : 
                  "¿Gastar 1 punto?";

        if(confirm(msg)) {
            let newPoints = currentUserData.points.yellow - 1;
            let newUnlocked = currentUserData.unlocked ? [...currentUserData.unlocked, id] : [id];
            
            // Esto actualiza la base de datos del usuario actual (o el observado)
            db.ref('users/' + currentUser).update({
                'points/yellow': newPoints,
                'unlocked': newUnlocked
            });
        }
    } else {
        alert("Faltan puntos");
    }
}

// Función para obtener todos los IDs hijos, nietos, etc. de un nodo
function getAllDescendants(nodeId) {
    const el = document.getElementById(nodeId);
    if (!el) return [];
    
    // Buscamos el LI padre que contiene al nodo y a su sub-lista (ul)
    const parentLi = el.parentElement;
    if (!parentLi) return [];

    // Buscamos todos los elementos con clase .node dentro de este LI
    const allNodes = parentLi.querySelectorAll('.node');
    
    let ids = [];
    allNodes.forEach(node => {
        // Agregamos todos MENOS el propio nodo padre (para no duplicarlo luego)
        if (node.id !== nodeId) {
            ids.push(node.id);
        }
    });
    return ids;
}

        
function tryUnlockMutual(el, myId, rivals) {
    // Verificación de seguridad
    if(!currentUserData) return;

    // 1. Si ya lo tengo, salir
    if(currentUserData.unlocked && currentUserData.unlocked.includes(myId)) return;
    
    // 2. Comprobar si está bloqueado visualmente o por lógica
    let isLocked = false;
    if(currentUserData.unlocked) {
        rivals.forEach(r => { if(currentUserData.unlocked.includes(r)) isLocked = true; });
    }
    if(isLocked) return alert("Ya elegiste el otro camino (Bloqueo Mutuo)");

    // 3. Comprobar puntos
    if(currentUserData.points.yellow > 0) {
        
        let msg = isAdminViewing ? 
                  "ADMIN: Elección permanente para " + currentUser + ". ¿Seguro?" : 
                  "Elección permanente. ¿Seguro? Se bloqueará el camino opuesto.";

        if(confirm(msg)) {
            let newPoints = currentUserData.points.yellow - 1;
            
            // Lista de desbloqueados
            let newUnlocked = currentUserData.unlocked ? [...currentUserData.unlocked, myId] : [myId];

            // --- AQUÍ ESTÁ LA MAGIA DEL BLOQUEO DE HIJOS ---
            // Empezamos con la lista actual de bloqueados
            let currentLocked = currentUserData.locked || [];
            
            // Creamos una lista con los rivales DIRECTOS
            let nodesToLock = [...rivals];

            // Para cada rival, buscamos también a toda su descendencia (hijos, nietos...)
            rivals.forEach(rivalId => {
                let descendants = getAllDescendants(rivalId);
                nodesToLock = [...nodesToLock, ...descendants];
            });

            // Combinamos todo y quitamos duplicados usando Set
            let finalLocked = [...new Set([...currentLocked, ...nodesToLock])];
            // ------------------------------------------------

            db.ref('users/' + currentUser).update({
                'points/yellow': newPoints,
                'unlocked': newUnlocked,
                'locked': finalLocked
            });
        }
    } else {
        alert("Faltan puntos (Amarillos)");
    }
}


// --- CERRAR SESIÓN ---
function logoutSystem() {
    // 1. Dejar de escuchar cambios en Firebase para ahorrar recursos
    if (currentUser) {
        db.ref('users/' + currentUser).off();
    }

    // 2. Limpiar variables
    currentUser = null;
    currentUserData = null;

    // 3. Volver al login
    showLogin();
    
    // Opcional: Recargar la página para limpiar visualmente el árbol 100%
    // location.reload(); 
    // Si prefieres que sea fluido sin recargar, usa showLogin() y asegúrate de limpiar clases:
    document.querySelectorAll('.node').forEach(el => el.classList.remove('unlocked', 'locked-forever'));
}


        // --- CONFIGURACIÓN MENÚ ---
        function toggleConfigMenu() {
            const menu = document.getElementById('config-menu');
            const btn = document.getElementById('config-btn');
            menu.classList.toggle('active');
            btn.classList.toggle('active');
        }

        function closeConfigMenu() {
            const menu = document.getElementById('config-menu');
            const btn = document.getElementById('config-btn');
            menu.classList.remove('active');
            btn.classList.remove('active');
        }

        // Theme handling with Auto (system preference)
        (function(){
            const mq = window.matchMedia('(prefers-color-scheme: light)');
            let mqListener = null;

            function applyThemeChoice(choice) {
                if(choice === 'light') {
                    document.body.classList.add('light-mode');
                    localStorage.setItem('noxTheme', 'light');
                    if(mqListener) { mq.removeEventListener('change', mqListener); mqListener = null; }
                } else if(choice === 'dark') {
                    document.body.classList.remove('light-mode');
                    localStorage.setItem('noxTheme', 'dark');
                    if(mqListener) { mq.removeEventListener('change', mqListener); mqListener = null; }
                } else { // auto
                    localStorage.setItem('noxTheme', 'auto');
                    const applyFromSystem = (e) => {
                        const isLight = e ? e.matches : mq.matches;
                        if(isLight) document.body.classList.add('light-mode'); else document.body.classList.remove('light-mode');
                    };
                    // apply immediately
                    applyFromSystem();
                    // listen to changes
                    mqListener = applyFromSystem;
                    mq.addEventListener('change', mqListener);
                }
            }

            window.changeTheme = function(theme) {
                applyThemeChoice(theme);
            }

            // On load, restore saved theme (supports 'auto')
            window.addEventListener('load', () => {
                const savedTheme = localStorage.getItem('noxTheme') || 'dark';
                // set select value if present
                const sel = document.getElementById('theme-select');
                if(sel) sel.value = savedTheme;
                applyThemeChoice(savedTheme);
            });
        })();

        function checkStaffCodeFromConfig(e) {
            if(e.key === 'Enter') {
                if(document.getElementById('config-staff-code').value === "StaffBuclEvoPuntNad") {
                    closeConfigMenu();
                    loadAdminPanel();
                    document.getElementById('config-staff-code').value = "";
                } else {
                    alert("Acceso Denegado");
                }
            }
        }

        // --- STAFF / ADMIN ---
        function checkStaffCode(e) {
            if(e.key === 'Enter') {
                if(document.getElementById('staff-code-input').value === "StaffBuclEvoPuntNad") {
                    loadAdminPanel();
                    document.getElementById('staff-code-input').value = "";
                } else {
                    alert("Acceso Denegado");
                }
            }
        }

        function loadAdminPanel(push = true) {
            if(push) history.pushState({page: 'admin'}, "Admin", "#admin");

            document.getElementById('intro-wrapper').style.display = 'none';
            document.getElementById('main-interface').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('logout-btn').style.display = 'none';

            db.ref('users').on('value', (snapshot) => {
                const list = document.getElementById('admin-user-list');
                list.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const u = childSnapshot.val();
                    const key = childSnapshot.key; 
                    
                    let row = `<tr>
                        <td>${u.username}</td>
                        <td>
                            A:${u.points.blue} | Am:${u.points.yellow} | M:${u.points.purple} <br>
                            <button class="btn-admin btn-plus" onclick="adminMod('${key}', 'blue', 1)">+Azul</button>
                            <button class="btn-admin btn-plus" onclick="adminMod('${key}', 'yellow', 1)">+Amarillo</button>
                            <button class="btn-admin btn-plus" onclick="adminMod('${key}', 'purple', 1)">+Morado</button>
                        </td>
                        <td>
                             A:${u.points.blue} | Am:${u.points.yellow} | M:${u.points.purple} <br>
                            <button class="btn-admin btn-minus" onclick="adminMod('${key}', 'blue', -1)">-Azul</button>
                            <button class="btn-admin btn-minus" onclick="adminMod('${key}', 'yellow', -1)">-Amarillo</button>
                            <button class="btn-admin btn-minus" onclick="adminMod('${key}', 'purple', -1)">-Morado</button>
                        </td>
                        <td><button class="btn-admin btn-view" onclick="viewUserTree('${key}')">Ver Árbol</button></td>
                        <td><button class="btn-admin btn-del" onclick="adminDel('${key}')">Borrar</button></td>
                    </tr>`;
                    list.innerHTML += row;
                });
            });
        }

        window.adminMod = function(userKey, type, val) {
            db.ref('users/' + userKey + '/points/' + type).transaction((current) => {
                return (current || 0) + val;
            });
        }

        window.adminDel = function(userKey) {
            if(confirm("Borrar " + userKey + "?")) {
                db.ref('users/' + userKey).remove();
            }
        }

window.viewUserTree = function(userKey) {
    // CAMBIO CLAVE: Usamos .on() en lugar de .once()
    // Así, si modificas algo (gastas puntos), la pantalla se entera y se actualiza sola.
    db.ref('users/' + userKey).on('value', (snapshot) => {
        if(snapshot.exists()){
            const data = snapshot.val();
            
            // Actualizamos las variables globales con los datos frescos
            currentUser = data.username;
            currentUserData = data;
            isAdminViewing = true;

            // Mostrar interfaz
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('main-interface').style.display = 'block';
            document.getElementById('admin-back-btn').style.display = 'block';
            document.getElementById('logout-btn').style.display = 'none';
            
            // Textos
            document.getElementById('tree-username').innerText = currentUser;
            document.getElementById('username-display').innerText = "VISTA REMOTA: " + currentUser;
            
            // Renderizar árbol y puntos actualizados
            updateHUD();
            renderTreeState();
        }
    });
};

function exitViewMode() {
    // Si estábamos viendo a alguien, dejamos de escuchar sus cambios
    if(currentUser) {
        db.ref('users/' + currentUser).off(); 
    }

    isAdminViewing = false;
    currentUser = null;
    currentUserData = null; // Limpiamos datos

    document.getElementById('main-interface').style.display = 'none';
    document.getElementById('admin-back-btn').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';
}

    </script>
</body>
</html>
